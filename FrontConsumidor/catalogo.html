<!-- =========================================
File: FrontConsumidor/catalogo.html  (build v108)
========================================= -->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PROFECO - Cat√°logo de Ofertas</title>
    <link rel="stylesheet" href="styles-profeco.css?v=108" />

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
        :root {
            --primary: #8B1538;
            --primary-2: #a91d47;
            --bg: #f5f5f5;
            --text: #333
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text)
        }

        .header {
            background: var(--primary);
            color: #fff;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .2)
        }

        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto
        }

        .search-box {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .08);
            display: flex;
            align-items: center
        }

        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            color: #555
        }

        .filter-section {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .08)
        }

        .filter-title {
            font-weight: 700;
            margin-bottom: 10px
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px
        }

        .filter-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary)
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px
        }

        .product-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, .1);
            transition: .2s;
            position: relative
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .12)
        }

        .product-image {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 52px
        }

        .discount-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--primary);
            color: #fff;
            border-radius: 20px;
            padding: 6px 10px;
            font-weight: 700
        }

        .product-info {
            padding: 16px
        }

        .product-name {
            font-weight: 700;
            margin-bottom: 6px
        }

        .price-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px
        }

        .product-price {
            color: var(--primary);
            font-weight: 800
        }

        .product-price-original {
            color: #999;
            text-decoration: line-through
        }

        .product-store {
            color: #666;
            font-size: 14px
        }

        .vigencia {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
            color: #999;
            font-size: 12px
        }

        .btn-heart {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            border-radius: 10px;
            background: var(--primary);
            color: #fff;
            padding: 10px 14px;
            cursor: pointer;
            margin-top: 10px
        }

        .btn-heart:hover {
            background: var(--primary-2)
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 30px
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 14px;
            color: #c33;
            margin: 12px 0
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: #f3f4f6;
            color: #374151;
            font-size: 12px
        }

        /* FABs √∫nicos */
        .fab-button {
            position: fixed;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: #fff;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 21, 56, .4)
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Cat√°logo de Ofertas</h1>
        <div class="user-info">
            <a href="deseos.html" class="pill">‚ù§Ô∏è Mis deseos</a>
            <span id="user-name"></span>
            <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
			<button class="logout-btn" onclick="abrirNotificaciones()" style="background: none; font-size: 1.2rem; margin-right: 10px;">
            üîî <span id="notif-count" style="background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: relative; top: -10px; left: -10px; display: none;">0</span>
        </button>
        </div>
    </div>

    <div class="content">
        <div class="search-box">
            <span style="margin-right:10px">üîé</span>
            <input type="text" id="searchInput" placeholder="Buscar productos o supermercados‚Ä¶">
        </div>

        <div class="filter-section">
            <div class="filter-title">Supermercados</div>
            <div id="filterOptions" style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="filter-btn active" data-supermercado="">Todos</button>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Cargando ofertas‚Ä¶</div>
        <div id="productGrid" class="product-grid"></div>
        <div id="noResults" class="loading" style="display:none">No se encontraron ofertas</div>
    </div>

    <!-- FABs unificados -->
    <button class="fab-button" style="bottom:310px;background:#8B1538" title="Lista de deseos"
        onclick="location.href='deseos.html'">‚ù§Ô∏è</button>
    <button class="fab-button" style="bottom:240px;background:#8B1538" title="Rese√±as"
        onclick="location.href='resenas.html'">‚≠ê</button>
    <button class="fab-button" style="bottom:170px;background:#a91d47" title="Registrar queja"
        onclick="location.href='quejas.html'">‚ö†Ô∏è</button>
    <button class="fab-button" style="bottom:100px;background:#8B1538" title="Reportar inconsistencia"
        onclick="location.href='reportes.html'">üìù</button>

    <!-- App -->
    <script>console.log('[CATALOGO] build v108', location.href);</script>
    <script>
        const API_BASE_URL = `http://${location.hostname || 'localhost'}:3000/api`;

        let token = localStorage.getItem('token');
        let usuario = null;
        try { usuario = JSON.parse(localStorage.getItem('usuario') || 'null'); } catch { usuario = null; }
        if (!token || !usuario) { /* por si abres file:// sin login */ usuario = { nombre: 'Juan Perez' }; }
        document.getElementById('user-name').textContent = usuario?.nombre || '';

        let todasLasOfertas = [];
        const supermercadosFiltro = new Set();

        document.getElementById('searchInput').addEventListener('input', filtrar);
        document.addEventListener('DOMContentLoaded', cargarOfertas);

async function abrirNotificaciones() {
    modal.classList.add('open');
    modalBody.innerHTML = '<div class="loading">Cargando notificaciones...</div>';

    try {
        // 1. Cargar la vista HTML desde la carpeta paralela FrontWishLists
        const response = await fetch('../FrontWishLists/notificacionesView.html');
        modalBody.innerHTML = await response.text();

        // 2. Cargar el script modular e inicializarlo (desde la carpeta paralela)
        // La ruta es relativa a catalogo.html (FrontConsumidor/ -> FrontWishLists/notificaciones.js)
        const { initNotificaciones } = await import('../FrontWishLists/notificaciones.js');
        initNotificaciones(usuario.id);

    } catch (e) {
        console.error("Error al cargar notificaciones:", e);
        modalBody.innerHTML = `<div class="error" style="background: #fee; padding: 10px; color: #c33;">Error al cargar: ${e.message}</div>`;
    }
}

function cerrarNotificaciones() {
    modal.classList.remove('open');
    // Al cerrar, actualizamos el contador por si se marcaron como le√≠das
    actualizarContadorNotificaciones();
}

// Funci√≥n para actualizar el badge de la campana
async function actualizarContadorNotificaciones() {
    if (!usuario) return;
    
    try {
      
        const url = `${API_BASE_URL}/notificaciones?usuarioId=${usuario.id}`; 
        
        const response = await fetch(url, {
             headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const res = await response.json();
        
        // Asumiendo el formato de respuesta { success: true, data: [...] }
        if (response.ok && res.data) { 
            const pendientes = res.data.filter(n => !n.leida).length;
            const badge = document.getElementById('notif-count');
            
            if (pendientes > 0) {
                badge.textContent = pendientes;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
    } catch (error) {
        console.warn("No se pudo actualizar el contador de notificaciones:", error);
    }
}

        async function cargarOfertas() {
            const loading = document.getElementById('loadingContainer');
            const errBox = document.getElementById('errorContainer');
            loading.style.display = 'block'; errBox.innerHTML = '';
            try {
                const r = await fetch(`${API_BASE_URL}/ofertas?activa=true`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const res = await r.json();
                if (!r.ok || !res.success) { throw new Error(res.mensaje || `HTTP ${r.status}`); }

                todasLasOfertas = Array.isArray(res.data) ? res.data : [];
                if (todasLasOfertas.length === 0) {
                    todasLasOfertas = demoOfertas();
                    errBox.innerHTML = `<div class="error">No hay ofertas en backend. Mostrando datos de demostraci√≥n.</div>`;
                }

                supermercadosFiltro.clear();
                todasLasOfertas.forEach(o => supermercadosFiltro.add(o.supermercado));
                crearFiltros(); render(todasLasOfertas);
            } catch (e) {
                console.error(e);
                errBox.innerHTML = `<div class="error">Error al cargar ofertas: ${e.message}</div>`;
                // demo si falla el fetch (file:// sin server)
                if (todasLasOfertas.length === 0) { todasLasOfertas = demoOfertas(); crearFiltros(); render(todasLasOfertas); }
            } finally { loading.style.display = 'none'; }
        }

        function crearFiltros() {
            const cont = document.getElementById('filterOptions');
            cont.querySelectorAll('button:not([data-supermercado=""])').forEach(n => n.remove());
            supermercadosFiltro.forEach(s => {
                const b = document.createElement('button'); b.className = 'filter-btn'; b.textContent = s; b.dataset.supermercado = s;
                b.onclick = () => { cont.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); filtrar(); };
                cont.appendChild(b);
            });
        }

        function filtrar() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const sel = document.querySelector('.filter-btn.active')?.dataset.supermercado || '';
            let list = todasLasOfertas;
            if (sel) list = list.filter(o => o.supermercado === sel);
            if (term) list = list.filter(o => o.producto.toLowerCase().includes(term) || o.supermercado.toLowerCase().includes(term));
            render(list);
        }

        function render(ofertas) {
            const grid = document.getElementById('productGrid'), no = document.getElementById('noResults');
            grid.innerHTML = ''; if (!ofertas.length) { no.style.display = 'block'; return; } no.style.display = 'none';
            const fondos = [
                'linear-gradient(135deg,#667eea 0%,#764ba2 100%)',
                'linear-gradient(135deg,#f093fb 0%,#f5576c 100%)',
                'linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)',
                'linear-gradient(135deg,#43e97b 0%,#38f9d7 100%)',
                'linear-gradient(135deg,#fa709a 0%,#fee140 100%)',
                'linear-gradient(135deg,#30cfd0 0%,#330867 100%)'
            ];
            ofertas.forEach((o, i) => {
                const card = document.createElement('div'); card.className = 'product-card';
                card.innerHTML = `
          <div class="discount-badge">-${Number(o.descuento || calcDesc(o)).toFixed(0)}%</div>
          <div class="product-image" style="background:${fondos[i % fondos.length]}">${icono(o.producto)}</div>
          <div class="product-info">
            <div class="product-name">${o.producto}</div>
            <div class="price-container">
              <span class="product-price-original">$${Number(o.precioOriginal).toFixed(2)}</span>
              <span class="product-price">$${Number(o.precioOferta).toFixed(2)}</span>
            </div>
            <div class="product-store">${o.supermercado}</div>
            <div class="vigencia">V√°lido del ${fmt(o.vigenciaInicio)} al ${fmt(o.vigenciaFin)}</div>
            <button class="btn-heart">üíñ A√±adir a deseos</button>
          </div>`;
                card.querySelector('.btn-heart').onclick = () => addToWishlist({
                    id: `${o.supermercado}-${o.producto}`.toLowerCase().replace(/\s+/g, '-'),
                    nombre: o.producto, supermercado: o.supermercado, precio: o.precioOferta
                });
                grid.appendChild(card);
            });
        }

        function icono(n) {
            n = (n || '').toLowerCase();
            if (n.includes('leche')) return 'ü•õ'; if (n.includes('pan')) return 'üçû'; if (n.includes('huevo')) return 'ü•ö';
            if (n.includes('manzana') || n.includes('fruta')) return 'üçé'; if (n.includes('pollo') || n.includes('carne')) return 'üçó';
            if (n.includes('jabon') || n.includes('limpieza')) return 'üß¥'; if (n.includes('tomate') || n.includes('jitomate')) return 'üçÖ';
            if (n.includes('queso')) return 'üßÄ'; if (n.includes('arroz')) return 'üçö'; if (n.includes('cafe')) return '‚òï'; return 'üõí';
        }
        function fmt(d) { const x = new Date((d || '') + 'T00:00:00'); return isNaN(x) ? 'N/D' : x.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' }) }
        function calcDesc(o) { const a = Number(o.precioOriginal || 0), b = Number(o.precioOferta || 0); return a ? (100 - (b * 100 / a)) : 0 }
        function logout() { localStorage.clear(); location.href = 'index.html' }

        // Demo si backend vac√≠o o sin server
        function demoOfertas() {
            const hoy = new Date(), fin = new Date(Date.now() + 7 * 864e5);
            const fmt = d => d.toISOString().slice(0, 10);
            const S = ['EcoMarket', 'SuperMax', 'HiperPlus', 'Bodega Aurrera'];
            const mk = (p, po, s) => ({ producto: p, precioOriginal: n(po), precioOferta: n(po * 0.8), descuento: 20, supermercado: s, vigenciaInicio: fmt(hoy), vigenciaFin: fmt(fin) });
            const n = x => Number(x).toFixed(2);
            return [
                mk('Leche entera 1L', 22, S[0]), mk('Pan blanco 680g', 42, S[1]), mk('Huevo docena', 39, S[2]),
                mk('Manzana roja kg', 48, S[0]), mk('Queso manchego 200g', 65, S[1]), mk('Caf√© molido 250g', 98, S[2]),
                mk('Arroz 1kg', 34, S[1]), mk('Jab√≥n l√≠quido 1L', 56, S[3])
            ];
        }
    </script>

    <script>
        (function () {
            const KEY = 'wishlist';
            const get = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } };
            const set = v => localStorage.setItem(KEY, JSON.stringify(v));
            function toast(msg) {
                const t = document.createElement('div');
                t.textContent = msg;
                t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#8B1538;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 16px rgba(139,21,56,.35);z-index:9999;font:14px system-ui';
                document.body.appendChild(t); setTimeout(() => t.remove(), 1400);
            }

            // SIN cantidad; lista √∫nica por id
            window.addToWishlist = function ({ id, nombre, supermercado, precio }) {
                const _id = String(id || `${supermercado}-${nombre}`.toLowerCase().replace(/\s+/g, '-'));
                const list = get();
                if (list.some(x => x.id === _id)) { toast('Ya est√° en tu lista'); return; }
                list.push({ id: _id, nombre, supermercado, precio: Number(precio || 0), notas: '' });
                set(list);
                toast('A√±adido a tu lista de deseos');
            };
        })();
		
		<div id="notifModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close" onclick="cerrarNotificaciones()">√ó</button>
        <div id="modalBody">
            <h2 style="color: #8B1538; margin-bottom: 10px;">Cargando...</h2>
        </div>
    </div>
</div>
    </script>

</body>

</html>